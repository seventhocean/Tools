<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>升级包构建工具</title>
    <!-- 引入Bootstrap CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #1e1e1e;
            color: #fff;
        }

        .container {
            max-width: 800px;
            margin-top: 50px;
        }

        .card {
            background-color: #2c2c2c;
            border: none;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .form-select,
        .form-control {
            background-color: #3a3a3a;
            color: #fff;
            border: 1px solid #444;
        }

        .form-select option {
            background-color: #1e1e1e;
        }

        .progress {
            height: 25px;
            border-radius: 12px;
            background-color: #3a3a3a;
        }

        .progress-bar {
            border-radius: 12px;
        }

        .log-container {
            height: 300px;
            overflow-y: auto;
            background-color: #3a3a3a;
            border-radius: 8px;
            padding: 15px;
            font-family: "Consolas", monospace;
            font-size: 14px;
            border: 1px solid #444;
        }

        .log-error {
            color: #f44336;
            font-weight: bold;
        }

        .btn {
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>

<body>
    <div class="container py-5">
        <h1 class="text-center mb-5">升级包构建工具</h1>
        <div class="card p-4">
            <form id="buildForm">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label">当前Patch版本</label>
                        <select class="form-select" id="currentVersion" required>
                            <option value="">加载中...</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">目标Patch版本</label>
                        <select class="form-select" id="targetVersion" required disabled>
                            <option value="">请先选当前版本</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary w-100 py-2" disabled>开始构建</button>
            </form>

            <div id="progressSection" class="text-center mt-4" style="display: none;">
                <div class="progress">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                        role="progressbar" style="width: 0%" aria-valuenow="0">0%</div>
                </div>
                <div class="log-container mt-3" id="logOutput"></div>
                <div id="downloadSection" class="text-center mt-4" style="display: none;">
                    <a id="downloadLink" class="btn btn-success py-2 px-4" target="_blank">下载升级包</a>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let versionData = [];
        let eventSource = null;

        document.addEventListener('DOMContentLoaded', () => {
            fetchVersions();
            initListeners();
        });

        async function fetchVersions() {
            const currentSelect = document.getElementById('currentVersion');
            currentSelect.innerHTML = '<option value="">加载中...</option>';

            try {
                const res = await fetch('/versions');
                const data = await res.json();

                if (data.success && data.versions) {
                    versionData = data.versions;
                    renderVersions();
                } else {
                    showAlert('获取版本失败', data.message || '未知错误');
                    currentSelect.innerHTML = '<option value="">加载失败</option>';
                }
            } catch (err) {
                showAlert('网络错误', `获取版本失败: ${err.message}`);
                currentSelect.innerHTML = '<option value="">网络异常</option>';
            }
        }

        function renderVersions() {
            const currentSelect = document.getElementById('currentVersion');
            const targetSelect = document.getElementById('targetVersion');
            const buildBtn = document.querySelector('button[type="submit"]');

            currentSelect.innerHTML = '<option value="">请选当前版本</option>';
            targetSelect.innerHTML = '<option value="">请选目标版本</option>';
            targetSelect.disabled = true;
            buildBtn.disabled = true;

            // 排序并填充当前版本
            const sorted = [...versionData].sort((a, b) => a.date.localeCompare(b.date));
            sorted.forEach(ver => {
                const opt = document.createElement('option');
                opt.value = ver.value;
                opt.textContent = ver.display;
                opt.dataset.date = ver.date;
                currentSelect.appendChild(opt);
            });
        }

        function initListeners() {
            document.getElementById('currentVersion').addEventListener('change', updateTarget);
            document.getElementById('targetVersion').addEventListener('change', checkBuildBtn);
            document.getElementById('buildForm').addEventListener('submit', startBuild);
            document.getElementById('downloadLink').addEventListener('click', checkDownload);
        }

        function updateTarget() {
            const currentOpt = document.getElementById('currentVersion').selectedOptions[0];
            const targetSelect = document.getElementById('targetVersion');
            targetSelect.innerHTML = '<option value="">请选目标版本</option>';
            targetSelect.disabled = true;

            if (currentOpt && currentOpt.dataset.date) {
                const currentDate = currentOpt.dataset.date;
                const validTargets = versionData.filter(ver => ver.date > currentDate);

                if (validTargets.length === 0) {
                    targetSelect.innerHTML = '<option value="">暂无更新版本</option>';
                } else {
                    validTargets.forEach(ver => {
                        const opt = document.createElement('option');
                        opt.value = ver.value;
                        opt.textContent = ver.display;
                        opt.dataset.date = ver.date;
                        targetSelect.appendChild(opt);
                    });
                    targetSelect.disabled = false;
                }
            }
            checkBuildBtn();
        }

        function checkBuildBtn() {
            const currentVal = document.getElementById('currentVersion').value;
            const targetVal = document.getElementById('targetVersion').value;
            const buildBtn = document.querySelector('button[type="submit"]');
            buildBtn.disabled = !(currentVal && targetVal);
        }

        function startBuild(e) {
            e.preventDefault();
            const currentVersion = document.getElementById('currentVersion').value;
            const targetVersion = document.getElementById('targetVersion').value;
            const buildBtn = document.querySelector('button[type="submit"]');
            const progressSection = document.getElementById('progressSection');
            const logOutput = document.getElementById('logOutput');
            const downloadSection = document.getElementById('downloadSection');

            // 禁用按钮，避免重复提交
            buildBtn.disabled = true;
            buildBtn.textContent = '构建中...';
            progressSection.style.display = 'block';
            logOutput.innerHTML = '';
            downloadSection.style.display = 'none';
            updateProgress(0, '构建任务已启动，等待后端响应...');

            // 关闭之前的 SSE 连接
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }

            // 建立新的 SSE 连接
            eventSource = new EventSource(`/build?current=${encodeURIComponent(currentVersion)}&target=${encodeURIComponent(targetVersion)}`);

            eventSource.onmessage = function (event) {
                try {
                    const data = JSON.parse(event.data);
                    handleBuildStatus(data);
                } catch (err) {
                    addLog(`消息解析失败: ${err.message}`, 'error');
                }
            };

            eventSource.onerror = function (err) {
                addLog(`SSE 连接异常: ${err.type}`, 'error');
                resetBuildState();
            };
        }

        function handleBuildStatus(statusData) {
            const buildBtn = document.querySelector('button[type="submit"]');
            const downloadLink = document.getElementById('downloadLink');
            const downloadSection = document.getElementById('downloadSection');

            switch (statusData.status) {
                case 'progress':
                    updateProgress(statusData.percent, statusData.message);
                    addLog(statusData.message, 'info');
                    break;
                case 'complete':
                    updateProgress(100, statusData.message);
                    addLog(statusData.message, 'success');
                    // 显示下载链接
                    downloadLink.href = statusData.download_url;
                    downloadSection.style.display = 'block';
                    // 恢复按钮状态
                    buildBtn.disabled = false;
                    buildBtn.textContent = '开始构建';
                    // 关闭 SSE 连接
                    if (eventSource) {
                        eventSource.close();
                        eventSource = null;
                    }
                    break;
                case 'error':
                    updateProgress(0, statusData.message);
                    addLog(statusData.message, 'error');
                    resetBuildState();
                    break;
                default:
                    addLog(`未知状态: ${statusData.status}`, 'info');
            }
        }

        function updateProgress(percent, message) {
            const progressBar = document.getElementById('progressBar');
            const safePercent = Math.max(0, Math.min(100, percent));
            progressBar.style.width = `${safePercent}%`;
            progressBar.textContent = `${safePercent}%`;
            progressBar.setAttribute('aria-valuenow', safePercent);

            if (message.includes('失败')) {
                progressBar.classList.remove('bg-primary', 'bg-success');
                progressBar.classList.add('bg-danger');
            } else if (safePercent === 100) {
                progressBar.classList.remove('bg-primary', 'bg-danger');
                progressBar.classList.add('bg-success');
            } else {
                progressBar.classList.remove('bg-danger', 'bg-success');
                progressBar.classList.add('bg-primary');
            }
        }

        function addLog(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            const logDiv = document.createElement('div');
            const timeStamp = new Date().toTimeString().slice(0, 8);

            if (type === 'error') {
                logDiv.className = 'log-error';
                logDiv.innerHTML = `[${timeStamp}] ❌ ${message}`;
            } else if (type === 'success') {
                logDiv.style.color = '#4caf50';
                logDiv.style.fontWeight = 'bold';
                logDiv.innerHTML = `[${timeStamp}] ✅ ${message}`;
            } else {
                logDiv.innerHTML = `[${timeStamp}] ℹ️ ${message}`;
            }

            logOutput.appendChild(logDiv);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function resetBuildState() {
            const buildBtn = document.querySelector('button[type="submit"]');
            buildBtn.disabled = false;
            buildBtn.textContent = '开始构建';
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        }

        async function checkDownload(e) {
            const downloadLink = this;
            const downloadUrl = downloadLink.href;

            downloadLink.classList.add('disabled');
            downloadLink.textContent = '校验文件...';

            try {
                const res = await fetch(downloadUrl, { method: 'HEAD' });
                if (res.ok) {
                    downloadLink.classList.remove('disabled');
                    downloadLink.textContent = '下载升级包';
                } else {
                    e.preventDefault();
                    downloadLink.classList.remove('disabled');
                    downloadLink.textContent = '下载升级包';
                    showAlert('下载失败', `文件不存在或已过期（状态码: ${res.status}）`, 'error');
                }
            } catch (err) {
                e.preventDefault();
                downloadLink.classList.remove('disabled');
                downloadLink.textContent = '下载升级包';
                showAlert('网络错误', `校验失败: ${err.message}`, 'error');
            }
        }

        function showAlert(title, message, type = 'info') {
            const alertDiv = document.createElement('div');
            const alertClass = type === 'error' ? 'alert-danger' : 'alert-info';
            alertDiv.className = `alert ${alertClass} alert-dismissible fade show fixed-top m-3 col-md-6 offset-md-3`;
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                <h5 class="alert-heading">${title}</h5>
                <p>${message}</p>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;

            document.body.appendChild(alertDiv);
            const alertInstance = new bootstrap.Alert(alertDiv);

            setTimeout(() => {
                alertInstance.close();
                alertDiv.remove();
            }, 5000);
        }
    </script>
</body>

</html>